# MLOps Titanic Pipeline (Airflow + MLflow + PyCaret)

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π MLOps‚Äë–∫–æ–Ω–≤–µ–π–µ—Ä:

- –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –¥–µ—Ç–µ–∫—Ü–∏—è data drift (PSI)
- –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ (PyCaret)
- –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ –≤ MLflow
- –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ REST API
- A/B‚Äë–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏ (Staging / Production)
- –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ Production

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
mlops_hw/
‚îú‚îÄ‚îÄ airflow_home/            # Airflow (DAGs, –ª–æ–≥–∏, –ë–î)
‚îÇ   ‚îú‚îÄ‚îÄ dags/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mlops_titanic_pipeline.py
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îú‚îÄ‚îÄ airflow.db
‚îÇ   ‚îî‚îÄ‚îÄ airflow.cfg
‚îÇ
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ train.csv            # –æ–±—É—á–∞—é—â–∞—è –≤—ã–±–æ—Ä–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ current.csv          # –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îÇ   ‚îî‚îÄ‚îÄ drift_flag.txt       # —Ñ–ª–∞–≥ –Ω–∞–ª–∏—á–∏—è –¥—Ä–∏—Ñ—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ best_model.pkl
‚îÇ   ‚îî‚îÄ‚îÄ pycaret_compare_results.csv
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ make_data.py
‚îÇ   ‚îú‚îÄ‚îÄ check_drift.py
‚îÇ   ‚îú‚îÄ‚îÄ train_with_pycaret.py
‚îÇ   ‚îú‚îÄ‚îÄ register_model.py
‚îÇ   ‚îú‚îÄ‚îÄ promote_to_production.py
‚îÇ   ‚îî‚îÄ‚îÄ sync_staging_with_production.py
‚îÇ
‚îú‚îÄ‚îÄ app.py                   # FastAPI inference server
‚îú‚îÄ‚îÄ mlflow.db
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ README.md
```

> ‚ÑπÔ∏è –§–∞–π–ª `pycaret_compare_results.csv` —Å–æ–∑–¥–∞—ë—Ç—Å—è PyCaret –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è –∏ –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –ª–∏–±–æ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞, –ª–∏–±–æ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `models/` ‚Äî —ç—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∑–∞–¥–∞—á–∏ Airflow. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –ø–∞–π–ø–ª–∞–π–Ω–∞.

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ (–æ–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

`make_data.py`:

- –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞—Ç–∞—Å–µ—Ç Titanic
- —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç `train.csv` –∏ `current.csv`

---

### 2. –î–µ—Ç–µ–∫—Ü–∏—è data drift

`check_drift.py`:

- –≤—ã—á–∏—Å–ª—è–µ—Ç PSI (Population Stability Index) –¥–ª—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ `age`, `fare`
- —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–∏–π PSI
- –µ—Å–ª–∏ `AVG_PSI > threshold` ‚Üí drift = True

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ShortCircuitOperator`:

- –µ—Å–ª–∏ drift = False ‚Üí –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- –µ—Å–ª–∏ drift = True ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–±—É—á–µ–Ω–∏–µ

–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `data/drift_flag.txt`.

---

### 3. –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

`train_with_pycaret.py`:

- –∑–∞–ø—É—Å–∫–∞–µ—Ç AutoML —á–µ—Ä–µ–∑ PyCaret
- —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–µ–π
- –≤—ã–±–∏—Ä–∞–µ—Ç –ª—É—á—à—É—é –ø–æ Accuracy
- —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ–¥–µ–ª—å –≤ `models/best_model.pkl`
- –ª–æ–≥–∏—Ä—É–µ—Ç —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –≤ MLflow

---

### 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏

`register_model.py`:

- –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –º–æ–¥–µ–ª—å
- —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –≤ MLflow Model Registry
- –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –µ—ë –≤ —Å—Ç–∞—Ç—É—Å **Staging**

---

### 5. –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –≤ Production

`promote_to_production.py`:

- –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏
- —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å —Ç–µ–∫—É—â–µ–π Production
- –µ—Å–ª–∏ –Ω–æ–≤–∞—è –ª—É—á—à–µ ‚Üí –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –µ—ë –≤ Production
- —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç—Å—è

---

### 6. API —Å–µ—Ä–≤–µ—Ä

`app.py`:

- FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª–∏ –∏–∑ MLflow
- –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è

Endpoint:

```
POST /predict
```

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:

```bash
curl -X POST http://127.0.0.1:8000/predict \
  -H "Content-Type: application/json" \
  -d '{"user_id":1,"features":{"pclass":3,"sex":"male","age":22,"fare":7.25,"sibsp":1,"parch":0,"embarked":"S"}}'
```

–û—Ç–≤–µ—Ç:

```json
{
  "predictions": [0],
  "stage": "Production"
}
```

---

## –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω A/B —Ç–µ—Å—Ç

A/B —Ç–µ—Å—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ inference API.

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

1. –í MLflow –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –º–æ–¥–µ–ª–∏:
   - Production
   - Staging

2. API –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
3. –ü–æ `user_id` –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –º–æ–¥–µ–ª—å:

```python
if user_id % 2 == 0:
    model = Production
else:
    model = Staging
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:

| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | –ú–æ–¥–µ–ª—å |
|-------------|---------|
| —á–µ—Ç–Ω—ã–π id   | Production |
| –Ω–µ—á–µ—Ç–Ω—ã–π id | Staging |

---

### –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ

- —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ
- –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤–Ω–µ–¥—Ä—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- —Å–æ–±–∏—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—à–∏–±–æ–∫

---

## Airflow DAG

DAG: `mlops_titanic_pipeline`

–ì—Ä–∞—Ñ –∑–∞–¥–∞—á:

```
make_data
    ‚Üì
check_drift
    ‚Üì
train_with_pycaret
    ‚Üì
register_model
    ‚Üì
promote_to_production
```

–ï—Å–ª–∏ drift –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω ‚Üí –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.

---

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

---

### 2. –ó–∞–ø—É—Å–∫ MLflow

```bash
mlflow ui --backend-store-uri sqlite:///mlflow.db
```

–û—Ç–∫—Ä–æ–µ—Ç—Å—è: http://127.0.0.1:5000

---

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Airflow

```bash
export AIRFLOW_HOME=$(pwd)/airflow_home
airflow db migrate
airflow standalone
```

UI: http://127.0.0.1:8080

---

### 4. –ó–∞–ø—É—Å–∫ DAG

–í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Airflow:

- –≤–∫–ª—é—á–∏—Ç—å `mlops_titanic_pipeline`
- –Ω–∞–∂–∞—Ç—å ‚ñ∂ Trigger

---

### 5. –ó–∞–ø—É—Å–∫ API

```bash
uvicorn app:app --reload
```

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—É—Å—Ç—ã–µ –ª–æ–≥–∏ –≤ UI

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

```bash
airflow tasks test mlops_titanic_pipeline check_drift 2026-01-16
```

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏.

---

### –ë–æ–ª—å—à–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ PyCaret

–ü—Ä–∏ —Å–ª–∞–±–æ–º –Ω–æ—É—Ç–±—É–∫–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:

- —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–µ–π
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `n_jobs=1`

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- Airflow 2.x
- MLflow
- PyCaret
- FastAPI
- scikit‚Äëlearn
- SQLite

---

## –ò—Ç–æ–≥

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

- –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
- –ø–µ—Ä–µ–æ–±—É—á–∞–µ—Ç –º–æ–¥–µ–ª—å
- —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
- –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–∫–∞—Ç—ã–≤–∞–µ—Ç –µ—ë —á–µ—Ä–µ–∑ A/B —Ç–µ—Å—Ç
- –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç –≤ Production

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π MLOps‚Äëpipeline üöÄ

